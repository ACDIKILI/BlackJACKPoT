<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BlackJACK Pot - KUTSAL DÖNÜŞ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; touch-action: none; }
        .phone { width: 100%; max-width: 360px; height: 100vh; max-height: 640px; background: radial-gradient(circle, #1a5d1a 0%, #0a3d0a 100%); border: 8px solid #333; border-radius: 40px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .game-title { position: absolute; bottom: 205px; color: gold; font-size: 22px; font-weight: bold; text-shadow: 0 0 10px rgba(255,215,0,0.5); letter-spacing: 2px; }
        .timer-container { position: absolute; left: 35px; top: 38%; transform: translateY(-50%); width: 70px; height: 70px; display: flex; justify-content: center; align-items: center; }
        .timer-circle { position: absolute; inset: 0; border: 4px solid rgba(255,255,255,0.1); border-radius: 50%; }
        .timer-glow { position: absolute; inset: -4px; border: 4px solid transparent; border-top-color: #ff4d4d; border-radius: 50%; }
        .is-running { animation: rotateGlow 2s linear infinite; }
        @keyframes rotateGlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .timer-text { color: #ff4d4d; font-size: 24px; font-weight: bold; font-family: monospace; z-index: 5; }
        .info-btn { width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; position: absolute; right: 35px; top: 38%; transform: translateY(-50%); font-style: italic; z-index: 20; }
        .header-area { height: 25%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .deck-box { width: 80px; height: 110px; background: linear-gradient(135deg, #c0392b, #8e44ad); border: 3px solid white; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: white; font-size: 40px; cursor: pointer; z-index: 10; }
        .restart-btn { width: 90px; height: 110px; background: #2c3e50; border: 3px solid white; border-radius: 10px; color: white; font-weight: bold; font-size: 14px; text-align: center; display: none; z-index: 500; cursor: pointer; justify-content: center; align-items: center; }
        .total-score { color: #f1c40f; font-size: 26px; font-weight: bold; text-shadow: 2px 2px 4px #000; background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 15px; z-index: 60; text-align: center; }
        .score-final { position: absolute; top: 45% !important; left: 50% !important; transform: translate(-50%, -50%) scale(1.1); border: 2px solid gold; background: rgba(0,0,0,0.95) !important; box-shadow: 0 0 40px gold; z-index: 1500; width: 280px; }
        .slots { width: 100%; display: flex; justify-content: space-around; padding: 0 5px; position: absolute; bottom: 80px; box-sizing: border-box; }
        .slot { width: 22%; height: 115px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 10px; display: flex; flex-direction: column; align-items: center; color: white; position: relative; padding-top: 5px; cursor: pointer; }
        .slot-score { font-size: 24px; font-weight: bold; pointer-events: none; }
        .bust-x { position: absolute; inset: 0; background: rgba(210, 0, 0, 0.95); display: none; justify-content: center; align-items: center; font-size: 14px; text-align:center; font-weight: bold; border-radius: 8px; color: white; z-index: 5; pointer-events: none; }
        .perfect-21 { border: 3px solid gold !important; background: rgba(255, 215, 0, 0.3) !important; box-shadow: 0 0 15px gold; }
        .closed-slot { border: 3px solid red !important; }
        .flying-card { position: absolute; width: 70px; height: 100px; background: white; border-radius: 8px; z-index: 100; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 22px; border: 2px solid #333; pointer-events: none; }
        .modal-overlay { position: absolute; inset: 0; background: #0a3d0a; display: none; z-index: 2000; border-radius: 32px; border: 8px solid #333; }
        .modal { padding: 30px 20px; color: white; text-align: center; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .signature { position: absolute; bottom: 15px; color: #fff; font-size: 12px; font-weight: 900; }
    </style>
</head>
<body id="mainBody">

<div class="phone" id="gameArea">
    <div class="header-area">
        <div class="timer-container">
            <div class="timer-circle"></div>
            <div class="timer-glow" id="timerGlow"></div>
            <div class="timer-text" id="timerDisplay">30</div>
        </div>
        <div class="deck-box" id="deck" onclick="baslat()">?</div>
        <div class="restart-btn" id="restartBtn" onclick="location.reload()">YENİDEN<br>BAŞLA</div>
        <div class="info-btn" onclick="modalAc()">i</div>
    </div>
    <div class="score-area"><div class="total-score" id="toplam">PUAN: 0</div></div>
    <div class="game-title">BlackJACK Pot</div>
    <div class="slots" id="slotsContainer">
        <div class="slot" id="maca" onclick="slotKapat('maca')"><span style="font-size:11px; color:gold;">x4</span><span style="font-size:30px">♠</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
        <div class="slot" id="kupa" onclick="slotKapat('kupa')"><span style="font-size:11px; color:gold;">x3</span><span style="color:#e74c3c; font-size:30px">♥</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
        <div class="slot" id="sinek" onclick="slotKapat('sinek')"><span style="font-size:11px; color:gold;">x2</span><span style="font-size:30px">♣</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
        <div class="slot" id="karo" onclick="slotKapat('karo')"><span style="font-size:11px; color:gold;">x1</span><span style="color:#e74c3c; font-size:30px">♦</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
    </div>
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h2 style="color:gold;">KUTSAL İNFO</h2>
            <div style="font-size:12px; text-align:left; line-height:1.5; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px;">
                <b style="color:gold;">KADEMELİ BONUS:</b><br>
                Her 50 puan diliminde bonus katlanır (+10, +20, +40...).<br><br>
                • <b>Hokus Pokus:</b> Kartlar geçtiği sütunun simgesine bürünür.<br>
                • <b>20 Puan:</b> +20 Puan ve Altın Çerçeve.<br>
                • <b>21 Puan:</b> +50 Puan ve KİLİT.<br>
                • <b>Zaman:</b> 30 Saniye. Metalik kalp atış sesine dikkat!<br>
                • <b>Kontrol:</b> Kartın sağına/soluna tıklayarak yön ver.
            </div>
            <button onclick="modalKapat()" style="margin-top:20px; padding:12px 30px; background:gold; border:none; border-radius:12px; font-weight:bold;">OYUNA DÖN</button>
        </div>
    </div>
    <div class="signature">A.C.Dikili & Gemini.AI</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBbtvGBl8m1x8thDlsUUutvujedIBCC4PA", 
        authDomain: "blackjack-4x4.firebaseapp.com",
        databaseURL: "https://blackjack-4x4-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "blackjack-4x4",
        storageBucket: "blackjack-4x4.firebasestorage.app",
        messagingSenderId: "805180924640",
        appId: "1:805180924640:web:c7da5f8c037b7ff5c26685"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const mults = { maca: 4, kupa: 3, sinek: 2, karo: 1 };
    let tPuan = 0, sPuan = {maca:0, kupa:0, sinek:0, karo:0}, aktif = {maca:true, kupa:true, sinek:true, karo:true};
    let isAnim = false, gameOver = false, saniye = 30, timerStarted = false, currentPosX = 0;
    const baseSpeed = 2.8;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playMetallicTick(sec) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(sec <= 10 ? 350 : 150, audioCtx.currentTime);
        gain.gain.setValueAtTime(sec <= 10 ? 0.4 : 0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function baslat() {
        if(!timerStarted) {
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
            startTimer();
            document.getElementById('timerGlow').classList.add('is-running');
        }
        kartCek();
    }

    function startTimer() {
        timerStarted = true;
        const interval = setInterval(() => {
            if(gameOver) { clearInterval(interval); return; }
            saniye--;
            document.getElementById('timerDisplay').innerText = saniye;
            playMetallicTick(saniye);
            if(saniye <= 0) { clearInterval(interval); bitti("ZAMAN DOLDU!"); }
        }, 1000);
    }

    function modalAc() { document.getElementById('modalOverlay').style.display = 'block'; }
    function modalKapat() { document.getElementById('modalOverlay').style.display = 'none'; }

    function kartCek() {
        if(isAnim || gameOver) return;
        isAnim = true;
        const val = Math.floor(Math.random()*13)+1;
        const slots = ['maca', 'kupa', 'sinek', 'karo'];
        createFallingCard(val, slots[Math.floor(Math.random() * 4)]);
    }

    function createFallingCard(val, startSuit) {
        const ga = document.getElementById('gameArea');
        const ar = ga.getBoundingClientRect();
        const slots = ['maca', 'kupa', 'sinek', 'karo'];
        const card = document.createElement('div');
        card.className = 'flying-card';
        currentPosX = (slots.indexOf(startSuit) * (ar.width/4)) + (ar.width/8) - 35;
        card.style.left = currentPosX + 'px'; card.style.top = '100px';
        ga.appendChild(card);

        const fallInterval = setInterval(() => {
            if(gameOver) { clearInterval(fallInterval); card.remove(); return; }
            let posY = parseFloat(card.style.top) + (baseSpeed * (1 + Math.min(tPuan / 1200, 0.3)));
            card.style.top = posY + 'px';
            
            // HOKUS POKUS MEKANİZMASI
            let index = Math.max(0, Math.min(3, Math.floor((currentPosX + 35) / (ar.width/4))));
            let curSuit = slots[index];
            const sym = {maca:'♠',kupa:'♥',sinek:'♣',karo:'♦'};
            card.innerHTML = (val===1?'A':val===11?'J':val===12?'Q':val===13?'K':val) + sym[curSuit];
            card.style.color = (curSuit === 'kupa' || curSuit === 'karo') ? 'red' : 'black';

            if(posY > document.getElementById('slotsContainer').offsetTop - 110) {
                clearInterval(fallInterval);
                finishCard(card, val, curSuit);
            }
        }, 16);

        document.getElementById('mainBody').onclick = (e) => {
            if(gameOver || e.target.classList.contains('slot')) return;
            const clickX = e.clientX - ar.left;
            if (clickX < currentPosX + 35) currentPosX -= 45; else currentPosX += 45;
            currentPosX = Math.max(10, Math.min(ar.width - 80, currentPosX));
            card.style.left = currentPosX + 'px';
        };
    }

    function finishCard(card, val, s) {
        const rect = document.getElementById(s).getBoundingClientRect();
        const ar = document.getElementById('gameArea').getBoundingClientRect();
        card.style.transition = '0.15s';
        card.style.left = (rect.left - ar.left + 5) + 'px';
        card.style.top = (rect.top - ar.top + 5) + 'px';
        card.style.transform = 'scale(0.8)';
        setTimeout(() => { card.remove(); if(!aktif[s]) bitti("YASAK BÖLGE!"); else guncelle(s, val); }, 150);
    }

    function guncelle(s, d) {
        let e = d > 10 ? 10 : d;
        if(d === 1) e = sPuan[s] + 11 <= 21 ? 11 : 1;
        sPuan[s] += e; tPuan += (e * mults[s]);
        const el = document.getElementById(s);
        el.querySelector('.slot-score').innerText = sPuan[s];
        if(sPuan[s] === 21) { 
            aktif[s] = false; tPuan += (50 * mults[s]); el.classList.add('perfect-21', 'closed-slot'); 
        } else if(sPuan[s] === 20) {
            tPuan += (20 * mults[s]); el.classList.add('perfect-21');
        } else if(sPuan[s] > 21) { 
            tPuan -= (sPuan[s] * mults[s]); sPuan[s] = 0; aktif[s] = false; 
            el.classList.add('closed-slot'); el.querySelector('.bust-x').style.display = 'flex'; 
        }
        document.getElementById('toplam').innerText = 'PUAN: ' + tPuan; isAnim = false;
        if(Object.values(aktif).every(v => !v)) bitti("OYUN BİTTİ");
    }

    function slotKapat(s) { if(aktif[s] && !isAnim && !gameOver) { aktif[s] = false; document.getElementById(s).classList.add('closed-slot'); if(Object.values(aktif).every(v => !v)) bitti("KAPATILDI"); } }

    function bitti(msg) {
        gameOver = true; document.getElementById('deck').style.display = 'none';
        document.getElementById('restartBtn').style.display = 'flex';
        document.getElementById('timerGlow').classList.remove('is-running');
        let bonus = 0; if(tPuan >= 50) bonus = 10 * Math.pow(2, Math.min(Math.floor(tPuan / 50) - 1, 10));
        tPuan += bonus;
        database.ref('world_scores').once('value', snapshot => {
            let rekorlar = snapshot.val() || [];
            if(rekorlar.length < 5 || tPuan > rekorlar[rekorlar.length-1].s) {
                let isim = prompt("DÜNYA REKORU! İsim yazın:", "Misafir");
                rekorlar.push({n: isim || "Misafir", s: tPuan});
                rekorlar.sort((a,b) => b.s - a.s);
                rekorlar = rekorlar.slice(0,5);
                database.ref('world_scores').set(rekorlar);
            }
            const dunyaHtml = rekorlar.map((r, i) => `${i+1}. ${r.n}: ${r.s}`).join('<br>');
            const box = document.getElementById('toplam');
            box.innerHTML = `<small>${msg}</small><br>SKOR: ${tPuan}<br><div style='font-size:11px; color:gold; margin-top:5px;'>DÜNYA TOP 5:<br>${dunyaHtml}</div>`;
            box.classList.add('score-final');
        });
    }
</script>
</body>
</html>