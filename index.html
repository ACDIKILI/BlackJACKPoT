<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BlackJACK Pot - FINAL EDITION</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; touch-action: none; }
        .phone { width: 100%; max-width: 360px; height: 100vh; max-height: 640px; background: radial-gradient(circle, #1a5d1a 0%, #0a3d0a 100%); border: 8px solid #333; border-radius: 40px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .login-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 32px; padding: 20px; text-align: center; }
        .login-input { padding: 15px; border-radius: 10px; border: 2px solid gold; margin: 15px 0; width: 80%; font-size: 20px; text-transform: uppercase; background: #222; color: white; text-align: center; }
        .login-btn { padding: 15px 40px; background: gold; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; }
        .user-panel { position: absolute; top: 15px; right: 25px; color: white; font-size: 11px; text-align: right; z-index: 100; }
        .header-area { height: 25%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .deck-box { width: 80px; height: 110px; background: linear-gradient(135deg, #c0392b, #8e44ad); border: 3px solid white; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: white; font-size: 40px; cursor: pointer; z-index: 10; }
        .timer-container { position: absolute; left: 35px; top: 38%; transform: translateY(-50%); width: 70px; height: 70px; display: flex; justify-content: center; align-items: center; }
        .timer-text { color: #ff4d4d; font-size: 24px; font-weight: bold; font-family: monospace; z-index: 5; }
        .timer-glow { position: absolute; inset: -4px; border: 4px solid transparent; border-top-color: #ff4d4d; border-radius: 50%; }
        .info-btn { width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; position: absolute; right: 35px; top: 48%; transform: translateY(-50%); font-style: italic; z-index: 1000; }
        .is-running { animation: rotateGlow 2s linear infinite; }
        @keyframes rotateGlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .total-score { color: #f1c40f; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000; background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 15px; z-index: 60; text-align: center; }
        .slots { width: 100%; display: flex; justify-content: space-around; padding: 0 5px; position: absolute; bottom: 80px; box-sizing: border-box; }
        .slot { width: 22%; height: 115px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 10px; display: flex; flex-direction: column; align-items: center; color: white; position: relative; padding-top: 5px; cursor: pointer; }
        .slot-score { font-size: 24px; font-weight: bold; pointer-events: none; }
        .bust-x { position: absolute; inset: 0; background: rgba(210, 0, 0, 0.95); display: none; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; border-radius: 8px; color: white; z-index: 5; pointer-events: none; }
        .perfect-21 { border: 3px solid gold !important; background: rgba(255, 215, 0, 0.3) !important; }
        .flying-card { position: absolute; width: 70px; height: 100px; background: white; border-radius: 8px; z-index: 100; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 22px; border: 2px solid #333; pointer-events: none; }
        .modal-overlay { position: absolute; inset: 0; background: #0a3d0a; display: none; z-index: 6000; border-radius: 32px; border: 8px solid #333; }
        .modal { padding: 30px 20px; color: white; text-align: center; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .score-final { position: absolute; top: 45% !important; left: 50% !important; transform: translate(-50%, -50%) scale(1.1); border: 2px solid gold; background: rgba(0,0,0,0.98) !important; box-shadow: 0 0 40px gold; z-index: 1500; width: 280px; padding: 15px; border-radius: 20px; color: white; text-align: center; }
        .signature { position: absolute; bottom: 15px; color: #fff; font-size: 12px; font-weight: 900; }
    </style>
</head>
<body id="mainBody">

<div class="phone" id="gameArea">
    <div id="loginScreen" class="login-screen">
        <h1 style="color:gold;">BlackJACK Pot</h1>
        <input type="text" id="pNameInput" class="login-input" placeholder="İSİM YAZINIZ">
        <p id="lError" style="color:#ff4d4d; font-size:12px; height:20px;"></p>
        <button class="login-btn" onclick="checkUser()">GİRİŞ YAP</button>
    </div>

    <div class="user-panel" id="uPanel" style="display:none;">
        <span id="pNameDisp" style="font-weight:bold; color:gold;">...</span><br>
        <span>TOPLAM: <span id="pScoreDisp">0</span></span>
    </div>

    <div class="header-area">
        <div class="timer-container">
            <div class="timer-glow" id="timerGlow"></div>
            <div class="timer-text" id="timerDisplay">30</div>
        </div>
        <div class="deck-box" id="deck" onclick="baslat()">?</div>
        <div class="info-btn" onclick="modalAc()">i</div>
    </div>
    
    <div class="score-area"><div class="total-score" id="toplam">PUAN: 0</div></div>
    <div class="game-title" style="position:absolute; bottom:205px; color:gold; font-size:22px; font-weight:bold;">BlackJACK Pot</div>
    
    <div class="slots" id="slotsContainer">
        <div class="slot" id="maca" onclick="slotKapat('maca')"><span style="font-size:11px; color:gold;">x4</span><span style="font-size:30px">♠</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
        <div class="slot" id="kupa" onclick="slotKapat('kupa')"><span style="font-size:11px; color:gold;">x3</span><span style="color:#e74c3c; font-size:30px">♥</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
        <div class="slot" id="sinek" onclick="slotKapat('sinek')"><span style="font-size:11px; color:gold;">x2</span><span style="font-size:30px">♣</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
        <div class="slot" id="karo" onclick="slotKapat('karo')"><span style="font-size:11px; color:gold;">x1</span><span style="color:#e74c3c; font-size:30px">♦</span><span class="slot-score">0</span><div class="bust-x">KAPALI</div></div>
    </div>

    <div class="modal-overlay">
        <div class="modal">
            <h2 style="color:gold;">KUTSAL İNFO</h2>
            <div style="font-size:12px; text-align:left; line-height:1.5; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px;">
                • <b>KARİYER:</b> Her oyun puanın toplamına eklenir.<br>
                • <b>KONTROL:</b> Kartın sağına ve soluna tıklayarak hareket ettirebilir ve türünü (simgesini) değiştirebilirsiniz.<br>
                • <b>HOKUS POKUS:</b> Kartlar havada sütuna göre simge değiştirir.<br>
                • <b>30 Saniye:</b> Zaman dolmadan en iyi yerleşimi yap!
            </div>
            <button onclick="modalKapat()" style="margin-top:20px; padding:12px 30px; background:gold; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">OYUNA DÖN</button>
        </div>
    </div>
    <div class="signature">A.C.Dikili & Gemini.AI</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBbtvGBl8m1x8thDlsUUutvujedIBCC4PA", 
        databaseURL: "https://blackjack-4x4-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "blackjack-4x4",
        appId: "1:805180924640:web:c7da5f8c037b7ff5c26685"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let curUser = "", curTotal = 0;
    const mults = { maca: 4, kupa: 3, sinek: 2, karo: 1 };
    let tPuan = 0, sPuan = {maca:0, kupa:0, sinek:0, karo:0}, aktif = {maca:true, kupa:true, sinek:true, karo:true};
    let isAnim = false, gameOver = false, saniye = 30, timerStarted = false, currentPosX = 0;

    function checkUser() {
        const input = document.getElementById('pNameInput').value.trim().toUpperCase();
        const err = document.getElementById('lError');
        if(!input) { err.innerText = "İSİM YAZINIZ!"; return; }

        db.ref('career_players').once('value').then(snap => {
            const players = snap.val() || {};
            let exists = false, barindirir = false;
            for(let id in players) {
                let name = players[id].name;
                if(name === input) { exists = true; curTotal = players[id].score || 0; break; }
                if(input.includes(name) || name.includes(input)) { barindirir = true; break; }
            }
            if(barindirir && !exists) { err.innerText = "BU İSİM VEYA BENZERİ ALINMIŞ!"; }
            else {
                curUser = input;
                if(!exists) db.ref('career_players/' + input).set({name: input, score: 0});
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('uPanel').style.display = 'block';
                document.getElementById('pNameDisp').innerText = curUser;
                document.getElementById('pScoreDisp').innerText = curTotal;
            }
        });
    }

    function baslat() {
        if(gameOver) { reloadGame(); return; }
        if(!curUser) return;
        if(!timerStarted) { timerStarted = true; startClock(); document.getElementById('timerGlow').classList.add('is-running'); }
        kartCek();
    }

    function startClock() {
        const interval = setInterval(() => {
            if(gameOver) { clearInterval(interval); return; }
            saniye--; document.getElementById('timerDisplay').innerText = saniye;
            playTick(saniye);
            if(saniye <= 0) { bitti("ZAMAN DOLDU!"); clearInterval(interval); }
        }, 1000);
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTick(s) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'square'; osc.frequency.setValueAtTime(s <= 10 ? 350 : 150, audioCtx.currentTime);
        gain.gain.setValueAtTime(s <= 10 ? 0.3 : 0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function kartCek() {
        if(isAnim || gameOver) return;
        isAnim = true;
        createFallingCard(Math.floor(Math.random()*13)+1, ['maca','kupa','sinek','karo'][Math.floor(Math.random()*4)]);
    }

    function createFallingCard(val, startSuit) {
        const ga = document.getElementById('gameArea');
        const ar = ga.getBoundingClientRect();
        const slots = ['maca', 'kupa', 'sinek', 'karo'];
        const card = document.createElement('div');
        card.className = 'flying-card';
        currentPosX = (slots.indexOf(startSuit) * (ar.width/4)) + (ar.width/8) - 35;
        card.style.left = currentPosX + 'px'; card.style.top = '100px';
        ga.appendChild(card);
        const fallInterval = setInterval(() => {
            if(gameOver) { clearInterval(fallInterval); card.remove(); return; }
            let posY = parseFloat(card.style.top) + (2.8 * (1 + Math.min(tPuan / 1200, 0.3)));
            card.style.top = posY + 'px';
            let index = Math.max(0, Math.min(3, Math.floor((currentPosX + 35) / (ar.width/4))));
            let curSuit = slots[index];
            card.innerHTML = (val===1?'A':val===11?'J':val===12?'Q':val===13?'K':val) + {maca:'♠',kupa:'♥',sinek:'♣',karo:'♦'}[curSuit];
            card.style.color = (curSuit === 'kupa' || curSuit === 'karo') ? 'red' : 'black';
            if(posY > document.getElementById('slotsContainer').offsetTop - 110) { clearInterval(fallInterval); finishCard(card, val, curSuit); }
        }, 16);
        document.getElementById('mainBody').onclick = (e) => {
            if(gameOver || e.target.classList.contains('slot')) return;
            const clickX = e.clientX - ar.left;
            if (clickX < currentPosX + 35) currentPosX -= 45; else currentPosX += 45;
            currentPosX = Math.max(10, Math.min(ar.width - 80, currentPosX));
            card.style.left = currentPosX + 'px';
        };
    }

    function finishCard(card, val, s) {
        const rect = document.getElementById(s).getBoundingClientRect();
        card.style.transition = '0.15s';
        card.style.left = (rect.left - document.getElementById('gameArea').getBoundingClientRect().left + 5) + 'px';
        card.style.top = (rect.top - document.getElementById('gameArea').getBoundingClientRect().top + 5) + 'px';
        card.style.transform = 'scale(0.8)';
        setTimeout(() => { card.remove(); if(!aktif[s]) bitti("YASAK BÖLGE!"); else guncelle(s, val); }, 150);
    }

    function guncelle(s, d) {
        let e = d > 10 ? 10 : d; if(d === 1) e = sPuan[s] + 11 <= 21 ? 11 : 1;
        sPuan[s] += e; tPuan += (e * mults[s]);
        document.getElementById(s).querySelector('.slot-score').innerText = sPuan[s];
        if(sPuan[s] === 21) { aktif[s] = false; tPuan += (50 * mults[s]); document.getElementById(s).classList.add('perfect-21', 'closed-slot'); }
        else if(sPuan[s] === 20) { tPuan += (20 * mults[s]); document.getElementById(s).classList.add('perfect-21'); }
        else if(sPuan[s] > 21) { tPuan -= (sPuan[s] * mults[s]); sPuan[s] = 0; aktif[s] = false; document.getElementById(s).classList.add('closed-slot'); document.getElementById(s).querySelector('.bust-x').style.display = 'flex'; }
        document.getElementById('toplam').innerText = 'PUAN: ' + tPuan; isAnim = false;
        if(Object.values(aktif).every(v => !v)) bitti("OYUN BİTTİ");
    }

    function slotKapat(s) { if(aktif[s] && !isAnim && !gameOver) { aktif[s] = false; document.getElementById(s).classList.add('closed-slot'); if(Object.values(aktif).every(v => !v)) bitti("KAPATILDI"); } }

    function reloadGame() {
        tPuan = 0; saniye = 30; gameOver = false; timerStarted = false; isAnim = false;
        sPuan = {maca:0, kupa:0, sinek:0, karo:0}; aktif = {maca:true, kupa:true, sinek:true, karo:true};
        document.querySelectorAll('.slot').forEach(el => { el.classList.remove('perfect-21', 'closed-slot'); el.querySelector('.slot-score').innerText = '0'; el.querySelector('.bust-x').style.display = 'none'; });
        document.getElementById('toplam').innerText = 'PUAN: 0'; document.getElementById('timerDisplay').innerText = '30';
        document.getElementById('timerGlow').classList.remove('is-running');
        const f = document.querySelector('.score-final'); if(f) f.remove();
        document.getElementById('deck').style.display = 'flex';
    }

    function bitti(msg) {
        gameOver = true; document.getElementById('deck').style.display = 'none';
        let b = 0; if(tPuan >= 50) b = 10 * Math.pow(2, Math.min(Math.floor(tPuan / 50) - 1, 10));
        tPuan += b; curTotal += tPuan;
        db.ref('career_players/' + curUser).update({score: curTotal});
        document.getElementById('pScoreDisp').innerText = curTotal;
        db.ref('career_players').orderByChild('score').limitToLast(5).once('value', snap => {
            let list = []; snap.forEach(c => { list.push(c.val()); }); list.reverse();
            const dHtml = list.map((r, i) => `${i+1}. ${r.name}: ${r.score}`).join('<br>');
            const box = document.createElement('div'); box.className = 'score-final';
            box.innerHTML = `<small>${msg}</small><br>OYUN: ${tPuan}<br><span style='color:gold'>TOPLAM: ${curTotal}</span><br><hr><div style='font-size:11px; color:gold;'>DÜNYA LİSTESİ:<br>${dHtml}</div><br><button onclick="reloadGame()" style="padding:10px 20px; border:none; background:gold; font-weight:bold; border-radius:10px; cursor:pointer;">YENİ OYUN</button>`;
            document.getElementById('gameArea').appendChild(box);
        });
    }

    function modalAc() { document.querySelector('.modal-overlay').style.display = 'block'; }
    function modalKapat() { document.querySelector('.modal-overlay').style.display = 'none'; }
</script>
</body>
</html>
